name: Flatpak Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  build-flatpak:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install flatpak and flatpak-builder
      run: |
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder

    - name: Add Flathub repository
      run: |
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

    - name: Install Flatpak SDK and runtime
      run: |
        # Extract versions from the Flatpak manifest
        RUNTIME_VERSION=$(grep "runtime-version:" packaging/land.arcana.TarotCanvas.yml | cut -d "'" -f 2)
        BASE_VERSION=$(grep "base-version:" packaging/land.arcana.TarotCanvas.yml | cut -d "'" -f 2)
        
        # Install the required runtimes
        sudo flatpak install -y flathub org.kde.Platform//${RUNTIME_VERSION}
        sudo flatpak install -y flathub org.kde.Sdk//${RUNTIME_VERSION}
        sudo flatpak install -y flathub com.riverbankcomputing.PyQt.BaseApp//${BASE_VERSION}

    - name: Install just
      uses: extractions/setup-just@v2.0.0

    - name: Build Flatpak
      run: just build-flatpak
